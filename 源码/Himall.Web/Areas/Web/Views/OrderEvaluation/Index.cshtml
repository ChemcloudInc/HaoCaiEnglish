@{
    Layout = "~/Areas/Web/Views/Shared/_UserCenter.cshtml";
    ViewBag.Title = "Satisfaction evaluation";
}
@model IEnumerable<Himall.Model.ProductEvaluation>

<div class="box1 lh24">
    <div class="title">
        <span class="title_txt curr">Order Evaluate</span>
        <!--<span id="tip-num">(<span class="num-comment">@Model.Where(a => !a.EvaluationStatus).Count()</span>个待评价)</span>-->
    </div>
    <div class="border-box">
        <div class="tb-void tb-line">
            <table width="100%" cellspacing="0" cellpadding="0" border="0" id="product-comments">
                <colgroup>
                    <col width="430">
                    <col width="130">
                    <col width="134">
                    <col>
                </colgroup>
                <thead>
                    <tr>
                        <th>Prodct(s)</th>
                        <th>Order Date</th>
                        <th>Edit</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Count() == 0)
                    {
                        <tr><td colspan="4"><div class="empty"><b></b>No Records！</div></td></tr>
                    }
                    @{var i = 0;}
                    @foreach (var m in @Model)
                    {
                        i++;
                        <tr>
                            <td colspan="4">
                                <ul oid="1622972656" class="pro-info">
                                    <li class="fore1">
                                        <div class="p-info clearfix">
                                            <div class="p-img fl">
                                                <a href="@Url.Action("Detail", "Product", new { id = @m.ProductId })" target="_blank">
                                                    <img width="50" height="50" data-img="1" title="@m.ProductName" src="@m.ThumbnailsUrl" class="err-product">
                                                </a>
                                            </div>
                                            <div class="p-name fl">
                                                @{
                                                    var sp = string.Empty;
                                                    if (!string.IsNullOrWhiteSpace(m.Color)) { sp += string.Format("Color：{0}，", m.Color); }
                                                    if (!string.IsNullOrWhiteSpace(m.Size)) { sp += string.Format("Size：{0}，", m.Size); }
                                                    if (!string.IsNullOrWhiteSpace(m.Version)) { sp += string.Format("Specification：{0}，", m.Version); }
                                                    if (!string.IsNullOrWhiteSpace(sp))
                                                    {
                                                        sp = "【" + sp + "】";
                                                    }
                                                }
                                                <a href="@Url.Action("Detail", "Product", new { id = @m.ProductId,title=@m.ProductName })" target="_blank">@m.ProductName  @sp.TrimEnd('，')</a>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="fore2"><span class="ftx03">@m.BuyTime</span></li>
                                    <li class="fore3 forem">
                                        <a catethird="@m.Id" title="Write Evaluation" class="pj" href="#none">
                                            show/unshow<b class="icon-show"></b>
                                        </a><br />
                                    </li>

                                </ul>
                                <div class="clr"></div>

                                <div class="comment-box prompt01" id="@m.Id" style=" display:block;">
                                    <div class="box-t"></div>
                                    <div class="form">
                                        <div class="item">
                                            <span class="label"><em>*</em>Rating：</span>
                                            <div class="fl">
                                                <span class="commstar">
                                                    <a data-t="1" class="star1" href="javascript:;"></a>
                                                    <a data-t="2" class="star2" href="javascript:;"></a>
                                                    <a data-t="3" class="star3" href="javascript:;"></a>
                                                    <a data-t="4" class="star4" href="javascript:;"></a>
                                                    <a data-t="5" class="star5" href="javascript:;"></a>
                                                </span>
                                                <div class="clr"></div>
                                            </div>
                                            <span class="id_star msg-error-01 ml10 hide" style="display:none">Your rating is our motivation</span>
                                            <div class="clr"></div>
                                        </div>
                                        <div class="item item01">
                                            <span class="label">Content：</span>
                                            <div class="cont">
                                                <textarea id="cont_txt" name="cont_txt" class="id_cont_txt area area01">Nothing</textarea>
                                                <div class="clr"></div>
                                                <span class="id_cont msg-error-01 hide" style="display:none">10-500 characters</span>
                                                <div class="msg-text" style="display:none">10-500 characters</div>
                                            </div>
                                            <div class="clr"></div>
                                        </div>
                                        <div class="item item02">
                                            <input type="hidden" name="orderItemId" value="@m.Id" />
                                            @*<div class="fl">
                                                    <a class="btn btn-5 mr20 id_sub" style="color:#fff;" href="#none" data="@m.Id">
                                                        <span>评价</span>
                                                    </a>
                                                    <div class="msg-text"></div>
                                                </div>*@
                                            <div class="clr"></div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>



                    }
                </tbody>
            </table>
        </div>
    </div>
    <h3 class="sub-title">Satisfaction Evaluation</h3>
    <div class="border-box" style=" border-top:1px solid #e4e4e4;">
        @{var mark = ViewBag.Mark;}
        @{if (mark == 0)
        {
            <div class="service-rcol" style="display:block;">
                <div class="score-cont">
                    <div class="score">
                        <input type="hidden" value="1622972656" name="oid">
                        <input type="hidden" value="69" name="gid">
                        <input type="hidden" value="549656" name="sid">
                        <dl class="ev-list">
                            <dt>Products Package Satisfaction</dt>
                            <dd>
                                <span class="commstar" id="id_a">
                                    <a data-t="1" class="star1" href="javascript:;"></a>
                                    <a data-t="2" class="star2" href="javascript:;"></a>
                                    <a data-t="3" class="star3" href="javascript:;"></a>
                                    <a data-t="4" class="star4" href="javascript:;"></a>
                                    <a data-t="5" class="star5" href="javascript:;"></a>
                                </span>
                                <input type="hidden" name="ro1827" value="1827A2">
                                <span style="display:none;" class="d1 degree-text" id="id_a_txt"></span>
                            </dd>
                        </dl>
                        <dl class="ev-list">
                            <dt>Delivery speed satisfaction</dt>
                            <dd>
                                <span class="commstar" id="id_b">
                                    <a data-t="1" class="star1" href="javascript:;"></a>
                                    <a data-t="2" class="star2" href="javascript:;"></a>
                                    <a data-t="3" class="star3" href="javascript:;"></a>
                                    <a data-t="4" class="star4" href="javascript:;"></a>
                                    <a data-t="5" class="star5" href="javascript:;"></a>
                                </span>
                                <input type="hidden" name="ro1828">
                                <span style="display:none;" class="degree-text" id="id_b_txt"></span>
                            </dd>
                        </dl>
                        <dl class="ev-list">
                            <dt>Delivery service satisfaction</dt>
                            <dd>
                                <span class="commstar" id="id_c">
                                    <a data-t="1" class="star1" href="javascript:;"></a>
                                    <a data-t="2" class="star2" href="javascript:;"></a>
                                    <a data-t="3" class="star3" href="javascript:;"></a>
                                    <a data-t="4" class="star4" href="javascript:;"></a>
                                    <a data-t="5" class="star5" href="javascript:;"></a>
                                </span>
                                <input type="hidden" name="ro1829">
                                <span style="display:none;" class="degree-text" id="id_c_txt"></span>
                            </dd>
                        </dl>
                        <div class="op-btn">
                            <input type="hidden" value="@ViewBag.OrderId" id="OrderId" />
                            <a id="id_btn_x" class="btn btn-6" href="#none"><s></s><strong>Add</strong></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="score-succ hide">
                <span class="s_pf">Rating：</span><span class="s-star"></span>
                <h3 class="ftx02"><s class="icon-02"></s>Thanks for your Rating</h3>
            </div>
            <div class="clr"></div>
        }
        else
        {
            <div class="score-succ">
                <span class="s_pf">Rating：</span><span class="s-star st@{@mark}"></span>
                <h3 class="ftx02"><s class="icon-02"></s>Thanks for your Rating</h3>
            </div>
            <div class="clr"></div>
        }
        }
    </div>
</div>
<script>
    ; (function ($) {
        var star = '',
            uid = '862',
            cont = '',
            star1 = '',
            star2 = '',
            star3 = '';
        $('.commstar').children().each(function (i, e) {
            var obj = $(e);
            obj.bind('click', function () {
                obj.siblings().removeClass('active');
                obj.addClass('active');
                var a = obj.attr('data');
                if (a != uid) {
                    cont = '';
                    star = '';
                    uid = a;
                }
                star = obj.attr('data-t');
                obj.parent().attr('data', star);
            });
        });
        $('.id_cont_txt').each(function (i, e) {
            $(e).focus(function () {
                //$(e).val('');
                $(e).css('color', '#333');
            }).blur(function () {
                var a = $(e).attr('data');
                if (a != uid) {
                    cont = '';
                    star = '';
                    uid = a;
                }
                cont = $(e).val();
                if ($(e).val()) {
                    //
                } else {
                    $(e).val('Nothing');
                    $(e).css('color', '#333');
                }
            });
        });

        $('.id_sub').each(function (i, e) {
            $(e).bind('click', function () {
                var uid = $(e).attr('data'),
                    star = $('#' + uid + ' .commstar').attr('data'),
                    cont = $('#' + uid + ' .id_cont_txt').val();
                if (!star) {
                    $('#' + uid + ' .id_star').show();
                }
                if (!cont || (cont.length >= 150)) {
                    $('#' + uid + ' .id_cont').show();
                    return;
                }
                if (star && cont) {
                    var loading = showLoading();
                    $.ajax({
                        type: 'post',
                        url: "@Url.Action("AddComment", "UserComment")",
                        data: { star: star, content: cont, suborderid: uid },
                        dataType: "json",
                        success: function (data) {
                            loading.close();
                            $('#' + uid).hide('200');
                            $('.pj').each(function (i, e) {
                                if ($(e).attr('catethird') == uid) {
                                    $(e).html('Been evaluated');
                                    $(e).attr('catethird', 0);
                                }
                            });
                        }
                    });
                }
            });
        });

        $('.pj').each(function (i, e) {
            $(e).bind('click', function () {
                var id = $(e).attr('catethird');
                uid = id;
                if ($('#' + id).css('display') == 'block') {
                    $('#' + id).slideUp(100);
                } else {
                    $('#' + id).slideDown(100);
                }
            });
        });
        $('#id_a').children().each(function (i, e) {
            var obj = $(e);
            obj.bind('click', function () {
                obj.addClass('active');
                star1 = obj.attr('data-t');
                if (star == 1) {
                    $('#id_a_txt').show().removeClass().addClass('d1 degree-text').html('Bad');
                } else if (star == 2) {
                    $('#id_a_txt').show().removeClass().addClass('d1 degree-text').html('Bad');
                } else if (star == 3) {
                    $('#id_a_txt').show().removeClass().addClass('d3 degree-text').html('Medium');
                } else if (star == 4) {
                    $('#id_a_txt').show().removeClass().addClass('d3 degree-text').html('Good');
                } else if (star == 5) {
                    $('#id_a_txt').show().removeClass().addClass('d5 degree-text').html('Excellent');
                }
            });
        });
        $('#id_b').children().each(function (i, e) {
            var obj = $(e);
            obj.bind('click', function () {
                obj.addClass('active');
                star2 = obj.attr('data-t');
                if (star == 1) {
                    $('#id_b_txt').show().removeClass().addClass('d1 degree-text').html('Bad');
                } else if (star == 2) {
                    $('#id_b_txt').show().removeClass().addClass('d1 degree-text').html('Bad');
                } else if (star == 3) {
                    $('#id_b_txt').show().removeClass().addClass('d3 degree-text').html('Medium');
                } else if (star == 4) {
                    $('#id_b_txt').show().removeClass().addClass('d3 degree-text').html('Good');
                } else if (star == 5) {
                    $('#id_b_txt').show().removeClass().addClass('d5 degree-text').html('Excellent');
                }
            });
        });
        $('#id_c').children().each(function (i, e) {
            var obj = $(e);
            obj.bind('click', function () {
                obj.addClass('active');
                star3 = obj.attr('data-t');
                if (star == 1) {
                    $('#id_c_txt').show().removeClass().addClass('d1 degree-text').html('Bad');
                } else if (star == 2) {
                    $('#id_c_txt').show().removeClass().addClass('d1 degree-text').html('Bad');
                } else if (star == 3) {
                    $('#id_c_txt').show().removeClass().addClass('d3 degree-text').html('Medium');
                } else if (star == 4) {
                    $('#id_c_txt').show().removeClass().addClass('d3 degree-text').html('Good');
                } else if (star == 5) {
                    $('#id_c_txt').show().removeClass().addClass('d5 degree-text').html('Excellent');
                }
            });
        });

        $('#id_btn_y').bind('click', function () {
            var jsonArray = eval("[{'subOrderId':'','star':1,'content':''}]");
            jsonArray.splice(0, 1);
            $("#product-comments tr:gt(0)").each(function () {
                var uid = $("[name=orderItemId]", this).val();
                var star = 0;
                $(".commstar a", this).each(function () {
                    if ($(this).hasClass("active")) {
                        star = $(this).attr('data-t');
                    }
                });
                var cont = $("[name=cont_txt]", this).val() == "" ? "Nothing" : $("[name=cont_txt]", this).val();
                var arr = {
                    "subOrderId": uid,
                    "star": star,
                    "content": cont
                };
                jsonArray.push(arr);
            });
            //检测内容不超过500个字
            for (var i = 0; i < jsonArray.length; i++) {
                if (jsonArray[i].content.length > 500) {
                    $.dialog.tips("Maximum characters is 500！");
                    return false;
                }
                //if(jsonArray[i].content.length < 10)
                //{
                //    $.dialog.tips("心得不能少于10个字符！");
                //    return false;
                //}
            }
            //return false;
            var loading = showLoading();
            $.ajax({
                type: 'post',
                url: "/OrderEvaluation/AddOrderEvaluationAndComment",
                data: { PackMark: 0, DeliveryMark: 0, ServiceMark: 0, OrderId: $("#OrderId").val(), productCommentsJSON: JSON.stringify(jsonArray) },
                dataType: "json",
                success: function (data) {
                    loading.close();
                    if (data.success) {
                        window.location = "/userComment";
                    }
                    else {
                        $.dialog.errorTips(data.msg);
                    }

                }
            });

        });
        $('#id_btn_x').bind('click', function () {
            var jsonArray = eval("[{'subOrderId':'','star':1,'content':''}]");
            jsonArray.splice(0, 1);
            $("#product-comments tr:gt(0)").each(function () {
                var uid = $("[name=orderItemId]", this).val();
                var star = 0;
                $(".commstar a", this).each(function () {
                    if ($(this).hasClass("active")) {
                        star = $(this).attr('data-t');
                    }
                });
                var cont = $("[name=cont_txt]", this).val() == "" ? "Nothing" : $("[name=cont_txt]", this).val();
                var arr = {
                    "subOrderId": uid,
                    "star": star,
                    "content": cont
                };
                jsonArray.push(arr);
            });
            //检测内容不超过500个字
            for (var i = 0; i < jsonArray.length; i++) {
                if (jsonArray[i].content.length > 500) {
                    $.dialog.tips("Maximum characters is 500！");
                    return false;
                }
                //if (jsonArray[i].content.length < 10) {
                //    $.dialog.tips("心得不能少于10个字符！");
                //    return false;
                //}
            }

            if (star1 && star2 && star3) {
                var average = parseInt((+star1 + (+star2) + (+star3)) / 3, 10);
                $('.service-rcol').hide();
                $('.score-succ').show().children('.s-star').addClass('st' + average);
                var loading = showLoading();
                $.ajax({
                    type: 'post',
                    url: "/OrderEvaluation/AddOrderEvaluationAndComment",
                    data: { PackMark: star1, DeliveryMark: star2, ServiceMark: star3, OrderId: $("#OrderId").val(), productCommentsJSON: JSON.stringify(jsonArray) },
                    dataType: "json",
                    success: function (data) {
                        loading.close();
                        if (data.success) {
                            window.location = "/userComment";
                        }
                        else
                            $.dialog.errorTips(data.msg);

                    }
                });
            } else {
                $.dialog.tips("Please write satisfaction evaluation！");
            }
        });

    }(jQuery));


    $(function () {
        //默认满分
        $("#product-comments .star5").each(function () {
            $(this).trigger("click");
        });
    })
</script>
